"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.importWxssCssReg=exports.importWxssReg=void 0;const tslib_1=require("tslib"),tools_1=require("../../../../utils/tools"),customError_1=require("../../../../utils/customError"),path_1=tslib_1.__importDefault(require("path")),less=()=>require("less");function default_1(s,e){return{name:"summer-less",resolveExt:{wxss:"less"},async load(t,r){var o;if(r.endsWith(".less")){const a=Date.now(),i=(0,tools_1.pathRelative)(s.projectPath,r);let l=s.getFile("",i).toString();if(i!==s.getTargetPath(s.miniprogramRoot,"app")+".less"&&s.exists(s.miniprogramRoot,"app.less")){const e=(0,tools_1.pathRelative)(s.miniprogramRoot,path_1.default.dirname(i))||".";l=`@import (optional, reference) '${"."===e?".":(0,tools_1.pathRelative)(e,"./")}/app.less';\n${l}`}const p=[];l=l.replace(exports.importWxssReg,(s,e,t)=>(p.push(t),s.replace(t,t+"?css")));try{const i=await require("less").render(l,{sourceMap:{outputSourceFiles:!0},paths:this.rootPath?[this.rootPath]:[],filename:r,globalVars:null!==(o=null==e?void 0:e.globalVars)&&void 0!==o?o:{}}),u=i.css.replace(exports.importWxssCssReg,(s,e,t)=>{const r=t.slice(0,-4);return p.includes(r)?s.replace(t,r):s});if(i.imports.length)for(const s of i.imports)this.addWatchFile(s);let c=void 0;return i.map&&(c=JSON.parse(i.map),c.sources=c.sources.map(e=>path_1.default.posix.relative(s.projectPath,e))),{targetPath:t,source:{sourceCode:u,inputMap:c},process:[{cost:Date.now()-a,pluginName:"summer-less",action:"load"}]}}catch(s){throw(0,customError_1.makeCustomError)(s,customError_1.CustomErrors.SUMMER_PLUGIN_CODE_ERR)}}}}}exports.importWxssReg=/(?:^|\s)?(?:@import)(?:\s*)?(["'])([^"']+.wxss)\1(?:\s*);/g,exports.importWxssCssReg=/(?:^|\s)?(?:@import)(?:\s*)?(["'])([^"']+.wxss\?css)\1(?:\s*);/g,exports.default=default_1;